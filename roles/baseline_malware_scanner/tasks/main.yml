- name: Install rootkit checker (chkrootkit)
  ansible.builtin.dnf:
    name: "{{ malware_scanner_package | default('chkrootkit') }}"
    state: present
  when: enable_malware_scanner | default(false) | bool

- name: Create rootkit scan service
  ansible.builtin.copy:
    dest: /etc/systemd/system/baseline-rootkit-scan.service
    owner: root
    group: root
    mode: "0644"
    content: |
      [Unit]
      Description=Baseline rootkit scan (chkrootkit)

      [Service]
      Type=oneshot
      ExecStart=/usr/sbin/chkrootkit
  when: enable_malware_scanner | default(false) | bool

- name: Create rootkit scan timer (weekly)
  ansible.builtin.copy:
    dest: /etc/systemd/system/baseline-rootkit-scan.timer
    owner: root
    group: root
    mode: "0644"
    content: |
      [Unit]
      Description=Run baseline rootkit scan weekly

      [Timer]
      OnCalendar=weekly
      Persistent=true

      [Install]
      WantedBy=timers.target
  when: enable_malware_scanner | default(false) | bool

- name: Reload systemd and enable rootkit scan timer
  ansible.builtin.systemd:
    daemon_reload: true
  when: enable_malware_scanner | default(false) | bool

- name: Enable and start rootkit scan timer
  ansible.builtin.systemd:
    name: baseline-rootkit-scan.timer
    enabled: true
    state: started
  when: enable_malware_scanner | default(false) | bool
