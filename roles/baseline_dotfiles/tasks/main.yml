---
#- name: Set dotfiles home/user
#  set_fact:
#    dotfiles_home: "/home/user1"
#    dotfiles_user: "user1"

############################################################
# Ensure base directories exist
############################################################

- name: Ensure ~/.config exists
  file:
    path: "{{ dotfiles_home }}/.config"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"

- name: Ensure app config directories exist
  file:
    path: "{{ dotfiles_home }}/.config/{{ item }}"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"
  loop:
    - git
    - nvim
    - sway
    - waybar

- name: Ensure ~/.ssh exists
  file:
    path: "{{ dotfiles_home }}/.ssh"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0700"

############################################################
# Git config (XDG style) — only if present in role
############################################################

- name: Check if role git config exists
  stat:
    path: "{{ role_path }}/files/config/git/config"
  register: role_gitconfig

#- name: Install git config
#  copy:
#    src: config/git/config
#    dest: "{{ dotfiles_home }}/.config/git/config"
#    owner: "{{ dotfiles_user }}"
#    group: "{{ dotfiles_user }}"
#    mode: "0644"
#  when: role_gitconfig.stat.exists

- name: Install git config (templated)
  template:
    src: config/git/config.j2
    dest: "{{ dotfiles_home }}/.config/git/config"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"

###################[defaults]#########################################
# tmux — only if present
############################################################

- name: Check if role tmux config exists
  stat:
    path: "{{ role_path }}/files/tmux/.tmux.conf"
  register: role_tmux

- name: Install .tmux.conf
  copy:
    src: tmux/.tmux.conf
    dest: "{{ dotfiles_home }}/.tmux.conf"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_tmux.stat.exists

- name: Ensure ~/.tmux/plugins exists
  file:
    path: "{{ dotfiles_home }}/.tmux/plugins"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"

- name: Install TPM (tmux plugin manager)
  git:
    repo: "https://github.com/tmux-plugins/tpm.git"
    dest: "{{ dotfiles_home }}/.tmux/plugins/tpm"
    version: "master"
    update: true
  become: true
  become_user: "{{ dotfiles_user }}"

############################################################
# SSH config — safe (no keys) — only if present
############################################################

- name: Check if role ssh config exists
  stat:
    path: "{{ role_path }}/files/ssh/config"
  register: role_ssh

- name: Install SSH config
  copy:
    src: ssh/config
    dest: "{{ dotfiles_home }}/.ssh/config"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0600"
  when: role_ssh.stat.exists

############################################################
# Neovim config — only if present
############################################################

- name: Check if role nvim config exists
  stat:
    path: "{{ role_path }}/files/nvim"
  register: role_nvim

- name: Install Neovim config
  copy:
    src: nvim/
    dest: "{{ dotfiles_home }}/.config/nvim/"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"
  when: role_nvim.stat.exists

- name: Ensure Neovim data directory exists
  file:
    path: "{{ dotfiles_home }}/.local/share/nvim"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"

############################################################
# Sway
############################################################

- name: Check if sway config exists
  stat:
    path: "{{ role_path }}/files/config/sway/config"
  register: role_sway

- name: Install sway config
  copy:
    src: config/sway/config
    dest: "{{ dotfiles_home }}/.config/sway/config"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_sway.stat.exists

############################################################
# Waybar
############################################################

- name: Check if waybar config exists
  stat:
    path: "{{ role_path }}/files/config/waybar/config.jsonc"
  register: role_waybar_cfg

- name: Install waybar config
  copy:
    src: config/waybar/config.jsonc
    dest: "{{ dotfiles_home }}/.config/waybar/config.jsonc"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_waybar_cfg.stat.exists

- name: Check if waybar style exists
  stat:
    path: "{{ role_path }}/files/config/waybar/style.css"
  register: role_waybar_style

- name: Install waybar style
  copy:
    src: config/waybar/style.css
    dest: "{{ dotfiles_home }}/.config/waybar/style.css"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_waybar_style.stat.exists

- name: Ensure default shell is zsh for user1
  user:
    name: "{{ dotfiles_user }}"
    shell: /bin/zsh
- name: Check if role zshrc exists
  stat:
    path: "{{ role_path }}/files/zsh/.zshrc"
  register: role_zshrc

- name: Install .zshrc
  copy:
    src: zsh/.zshrc
    dest: "{{ dotfiles_home }}/.zshrc"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_zshrc.stat.exists

- name: Ensure ~/.config/alacritty exists
  file:
    path: "{{ dotfiles_home }}/.config/alacritty"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0755"

- name: Check if alacritty config exists in role
  stat:
    path: "{{ role_path }}/files/config/alacritty/alacritty.toml"
  register: role_alacritty

- name: Install alacritty config
  copy:
    src: config/alacritty/alacritty.toml
    dest: "{{ dotfiles_home }}/.config/alacritty/alacritty.toml"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: "0644"
  when: role_alacritty.stat.exists

- name: Clone private overlay repo (optional)
  git:
    repo: "{{ private_overlay_repo }}"
    dest: "{{ private_overlay_dest }}"
    version: "{{ private_overlay_branch | default('main') }}"
    update: true
  become: true
  become_user: "{{ dotfiles_user }}"
  when: private_overlay_repo is defined and private_overlay_repo | length > 0
  ignore_errors: true

- name: Apply private overlay (optional)
  command: >
    rsync -a --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r
    "{{ private_overlay_dest }}/" "{{ dotfiles_home }}/"
  become: true
  when: private_overlay_repo is defined and private_overlay_repo | length > 0
  ignore_errors: true
